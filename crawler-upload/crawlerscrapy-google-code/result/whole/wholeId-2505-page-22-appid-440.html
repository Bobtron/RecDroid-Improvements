https://code.google.com/archive/p/csipsimple/issues/2326<!DOCTYPE html><html class="google ng-scope" lang="en" ng-app="codesiteArchive.application"><head>
    <meta charset="utf-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">

    <!-- https://developers.google.com/webmasters/ajax-crawling/docs/specification -->
    <meta name="fragment" content="!">
    <title>Google Code Archive - Long-term storage for Google Code Project Hosting.</title>

    <link rel="icon" type="image/vnd.microsoft.icon" href="/archive/img/project-hosting.ico">
    <script src="//www.google.com/js/google.js"></script>
    <link href="//www.google.com/css/maia.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;lang=en" rel="stylesheet">
    <link rel="stylesheet" href="/archive/archive_css.css">
    <script>
      CLOSURE_NO_DEPS = true;
    </script>
    <script src="/archive/angular.js"></script><style type="text/css">@charset "UTF-8";

[ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak],
.ng-cloak, .x-ng-cloak,
.ng-hide:not(.ng-hide-animate) {
  display: none !important;
}

ng\:form {
  display: block;
}

.ng-animate-shim {
  visibility:hidden;
}

.ng-anchor {
  position:absolute;
}
</style>
    <script src="/archive/pagedown.js"></script>
    <script src="/archive/archive.js"></script>
    <base href="/archive/">
  </head>

  <body>
    <div class="maia-header" id="maia-header" role="banner">
      <div class="maia-aux">
        <a href="/archive/">
          </a><h1><a href="/archive/">
            <img alt="Google" src="//www.google.com/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png"> Code</a>
          </h1>
        
        <a href="/archive/">
          <h2>Archive</h2>
        </a>
        <a class="maia-teleport" href="#content">Skip to content</a>
        <div class="maia-util">
          <form action="/archive/search" class="maia-search ng-pristine ng-valid">
            <input name="q" placeholder="Search this site" type="text">
            <button class="maia-button">
              <span class="maia-search-icon">Search</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ngView: --><div ng-view="" class="ng-scope"><div ng-controller="ProjectIssueCtrl as issueCtrl" class="ng-scope">
<nav-bar-widget nav-level-1="projectCtrl.navLevel1" class="ng-isolate-scope"><div class="maia-nav maia-complex" id="maia-nav-x" role="navigation">
  <div class="maia-aux">
    <ul>
      <li ng-class="{active: navLevel1 == 'projects'}">
        <a href="/archive/">Projects</a>
        <!-- ngIf: navLevel2 -->
      </li>
      <li ng-class="{active: navLevel1 == 'search'}">
        <a href="/archive/search">Search</a>
      </li>
      <li ng-class="{active: navLevel1 == 'about'}">
        <a href="/archive/about">About</a>
      </li>
    </ul>
  </div>
</div>
</nav-bar-widget>
<div id="maia-main" role="main">

  <!-- ngIf: issueCtrl.notFound -->

  <div ng-hide="issueCtrl.notFound">
    <!-- Left-side resource nav -->
    <project-resources-widget domain="issueCtrl.domain" project="issueCtrl.projectName" class="ng-isolate-scope"><div class="maia-nav" id="maia-nav-y" role="navigation">
  <!-- ngIf: domain == 'code.google.com' --><ul ng-if="domain == 'code.google.com'" class="ng-scope">
    <li class="active">
      <a href="/archive/p/csipsimple/">Project</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/source">Source</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/issues">Issues</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/wikis">Wikis</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/downloads">Downloads</a>
    </li>
  </ul><!-- end ngIf: domain == 'code.google.com' -->

    <!-- ngIf: domain != 'code.google.com' -->
</div></project-resources-widget>

    <div class="maia-article" role="article">
      <div class="maia-teleport" id="content"></div>
      <div class="maia-cols">
        <div id="gca-project-header" class="maia-col-10">
          <a id="gca-export-to-gh" class="maia-button" href="https://code.google.com/export-to-github/export?project=csipsimple">Export to GitHub</a>
            <img class="gca-project-logo" src="https://storage.googleapis.com/google-code-archive/v2/code.google.com/csipsimple/logo.png">
            <h1 class="ng-binding">csipsimple - issue #2326</h1>
            <p class="ng-binding">KA reliability</p>
        </div>

        <div class="maia-col-10">
          <hr>

        <!-- ngIf: issueCtrl.error -->

        <!-- ngIf: !issueCtrl.error --><div ng-if="!issueCtrl.error" class="ng-scope">
          <!-- Comments -->
          <div class="maia-col-8">
            <!-- ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Apr 16, 2013 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p><b>What steps will reproduce the problem?</b>
1. Watch CSS from SIP server's side for KA messages
2. Observe that sometimes they stop and leave CSS behind NAT inaccessible for incoming calls</p>

<p><b>What is the expected output? What do you see instead?</b>
Expected: CSS always sends KA messages on regular basis
Instead: time to time CSS stops sending KA messages</p>

<p><b>What version of the product are you using? On what operating system?</b>
CSS r2194. Android 4.1.2</p>

<p><b>Please provide any additional information below.</b>
Usually it works and KA are sent on a regular basis. But time to time I see that CSS stops sending them for whatever reason. Then, after sending next REGISTER request, it resumes as usual.</p>

<p>It looks like there are two different mechanisms:
1) to send REGISTER requests in time (and it works fine) and 
2) to send KA messages, that is not reliable</p>

<p>Here is an example of log, documenting this problem:
<a href="http://img197.imageshack.us/img197/8830/css01.png">http://img197.imageshack.us/img197/8830/css01.png</a></p>

<p>As you can see, KA message is expected to be sent at:
a) 10:35:53 (after KA packet #6)
b) 11:05:55 (after KA packet #36)
In both cases, CSS suddenly stops sending KA packets...</p>

<p>Whole log shows, that similar events were continuing too. I just didn't mention them to publish smaller picture and save our time...</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #1</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Apr 17, 2013 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Another day, another example... Here is the log:
<a href="http://img688.imageshack.us/img688/6853/css2c.png">http://img688.imageshack.us/img688/6853/css2c.png</a></p>

<ol>
<li>After packet #10 @10:22:02 CSS ceased to send KA packets. As a result, it can't accept new call.</li>
<li>Packet #7 @10:17:32 - new call arrives. Because CSS did not ring, call was canceled...</li>
<li>At 10:26:02 CSS sends its next REGISTER request, waking up its SIP stack, which in turn start processing the already abandoned call</li>
<li>At 10:26:10 (packet #26) CSS acknowledges canceled call and went into deep sleep again... No keep alive messages were sent since that time!!! And therefore any attempt to make call at this time would failed...</li>
<li>At 10:36:04 (packet #27) CSS resumes its operations</li>
</ol>

<p>Bottom line:
CSS may suddenly stop sending KA and it prevents CSS from receiving new incoming calls in time.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #2</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on May 5, 2013 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>r2210 fixes a problem with the timer implementation. Maybe this issue was a consequence of the bug in timer implementation.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #3</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on May 5, 2013 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>On my HTC Aria I'm not running on v4.1.2 at this time. I'm running Android 2.2 now. So, I can't confirm if it fixes the bug. But I'll check it next time I switch for v4.1.2. I can't use v4.1.2 because lot of programs are not working there (including GPS, getting fix in 5-7 min instead of 5-7 sec, as an example). I don't use it even though I've noticed that CSS runs better (more reliable) on v4.1.2, than on v2.2. </p>

<p>Is there any difference (from source code perspective) when it runs on Android v4.1.2 vs v2.2? Setting aside that particular KA problem, I've noticed, that CSS doesn't miss incoming calls in v4.1.2 as it often does in v2.2 and it wakes up almost immediately when INVITE message arrives. Do you use different wake up procedures (for receiving incoming network packets) for different versions of Android?</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #4</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on May 5, 2013 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>In terms of code it's absolutely identical. 
In terms of what you observe that depends on android version, it's absolutely normal. And worse, it's device dependent !</p>

<p>It's hightly related on how is developed the chipset driver and what are the settings used to build the android ROM. That's why it's far to be easy for me to solve this kind of problem. Because it depends on the device+the android version+the ROM+the chipset+the network.</p>

<p>For example, the latest 4.2.2 on the Nexus 4 has an awful problem that just totally break the network when the device goes to sleep. And that one is known/confirmed by Google (and many users are crying on google bug tracker). 
The only thing the app could do in such situation is to behaves as a battery killer by adopting strategies that poll regularly CPU or directly take a lock on the CPU/network. There is such options in csipsimple, but not enabled by default. 
Manufacturers that have problems with battery tries to reduce the power of the network chipset and increase the latency to retrieve network packets. And, it has indeed an impact. Such rom could save a lot of battery, but could also make absolutely useless apps that play with network in background. It's less annoying for chat or email, but when it's an incoming voice call... it's not the same need in terms of reactivity.</p>

<p>So except adding some of the workaround as default setting on some specific devices+specific version (and I do that rarely for these options even when I know that there is actually a problem because it has big impact on battery usage), there is no specific strategy.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #5</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on May 5, 2013 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Thank you, Regis. Frankly that's the answer, I was afraid to receive... </p>

<p>Waking up app at the time, when a network packet arrives, is a core functionality of any real time OS. It has the same importance as e.g. a timer, waking up app at specific time. If both work unreliably - that OS can't be called a real time OS... Unfortunately looking at the history of Android development (v2.2 it doesn't work, v4.1.2 it's somehow fixed, v4.2.2 it's broken again) one may come to a sad conclusion, that designers of the OS and/or perhaps manufacturers, developing network drivers for their devices, don't understand importance of that. As a result, it makes Android a lame platform for development real time apps (such as softphones) and ironically Android was developed for smartphones... Now, from the consumer perspective, buying a new smartphone becomes like a buying a lottery ticket. You can win (and you can run softphone on it) or you can lose (and discover later, that you can do nothing abut it)... It's all very sad :(</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #6</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on May 6, 2013 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>I don't think Android claimed to be a real time OS and I don't think it aims to be a real time OS. A real time OS is something very special (few OS can claim to be real time ones).
And it's also not a desktop OS nor a server OS.
It's a mobile OS and they focus more on low consumption than on network reliability. </p>

<p>It's a shame for our current use case, yes; but our use case is not their priority. Even low latency audio is not their priority (they started some work but it's far to be good enough yet). 
When it will be time for them to address voice over IP for IMS, they will address that with dedicated chipsets or specific code with higher privileged (as was the case on the Nokia phones).</p>

<p>Also, it's not only Android. iOS has very low capabilities in terms of network in background : you have to do a weird action on each socket you'd like to be able to receive data in background, it doesn't work equally on each of their version... and that despite of the fact they have only one hardware to manage (and develop both hardware and software).
I also fear that same kind of assumptions will be done in first times for web based mobile OS too (probably having a background app will be very complicate for these OS in their first releases). </p>

<p>So, yes it's a shame, yes it's very annoying for the SIP use case, and we can be very disappointed to see that Google that knows some problems do such big mistakes when building ROM for their own devices; but I don't think it's a case that they focus on and it has probably less importance for them than providing a device with lower battery usage. Battery usage can make their product be rejected by 99% users while low network reliability will be annoying for significantly lower number of users. 
Fortunately with Android and the fact it's opensource, you'll often find ROM that hack weird default behavior of manufacturers. For the example for the problem I mentioned on the Nexus 4, once rooted and with a custom driver for the wifi chipset the problem can be solved. That's why it's very important to push the opensource way. So that people are not dependent of assumption of some commercial companies that only focus on mainstream users and market shares.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments -->
          </div>

          <!-- Sidebar with additional information -->
          <div class="maia-col-4">
            <div class="maia-aside">
              <p>Status: <code class="ng-binding">Obsolete</code></p>
              <!-- ngIf: issueCtrl.issue.labels.length > 0 --><p ng-if="issueCtrl.issue.labels.length &gt; 0" class="ng-scope">
                Labels:
                <br>
                <!-- ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Type-Defect</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Priority-Medium</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index -->
              </p><!-- end ngIf: issueCtrl.issue.labels.length > 0 -->
            </div>
          </div>
        </div><!-- end ngIf: !issueCtrl.error -->
      </div>
    </div>

  </div>
</div>
</div></div></div>
    <noscript>
      &lt;p&gt;The Google Code Archive requires JavaScript to be enabled in your browser.&lt;/p&gt;
    </noscript>

    <div id="maia-signature"></div>
    <div class="maia-footer" id="maia-footer">
      <div id="maia-footer-local">
      </div>
      <div id="maia-footer-global">
        <div class="maia-aux">
          <ul>
            <li>
              <a href="//www.google.com/">Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/about/">About Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/privacy/">Privacy</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/terms/">Terms</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="//www.google.com/js/maia.js"></script>
  


</body></html>