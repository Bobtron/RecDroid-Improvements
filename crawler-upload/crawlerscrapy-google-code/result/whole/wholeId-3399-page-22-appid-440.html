https://code.google.com/archive/p/csipsimple/issues/1423<!DOCTYPE html><html class="google ng-scope" lang="en" ng-app="codesiteArchive.application"><head>
    <meta charset="utf-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">

    <!-- https://developers.google.com/webmasters/ajax-crawling/docs/specification -->
    <meta name="fragment" content="!">
    <title>Google Code Archive - Long-term storage for Google Code Project Hosting.</title>

    <link rel="icon" type="image/vnd.microsoft.icon" href="/archive/img/project-hosting.ico">
    <script src="//www.google.com/js/google.js"></script>
    <link href="//www.google.com/css/maia.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;lang=en" rel="stylesheet">
    <link rel="stylesheet" href="/archive/archive_css.css">
    <script>
      CLOSURE_NO_DEPS = true;
    </script>
    <script src="/archive/angular.js"></script><style type="text/css">@charset "UTF-8";

[ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak],
.ng-cloak, .x-ng-cloak,
.ng-hide:not(.ng-hide-animate) {
  display: none !important;
}

ng\:form {
  display: block;
}

.ng-animate-shim {
  visibility:hidden;
}

.ng-anchor {
  position:absolute;
}
</style>
    <script src="/archive/pagedown.js"></script>
    <script src="/archive/archive.js"></script>
    <base href="/archive/">
  </head>

  <body>
    <div class="maia-header" id="maia-header" role="banner">
      <div class="maia-aux">
        <a href="/archive/">
          </a><h1><a href="/archive/">
            <img alt="Google" src="//www.google.com/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png"> Code</a>
          </h1>
        
        <a href="/archive/">
          <h2>Archive</h2>
        </a>
        <a class="maia-teleport" href="#content">Skip to content</a>
        <div class="maia-util">
          <form action="/archive/search" class="maia-search ng-pristine ng-valid">
            <input name="q" placeholder="Search this site" type="text">
            <button class="maia-button">
              <span class="maia-search-icon">Search</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ngView: --><div ng-view="" class="ng-scope"><div ng-controller="ProjectIssueCtrl as issueCtrl" class="ng-scope">
<nav-bar-widget nav-level-1="projectCtrl.navLevel1" class="ng-isolate-scope"><div class="maia-nav maia-complex" id="maia-nav-x" role="navigation">
  <div class="maia-aux">
    <ul>
      <li ng-class="{active: navLevel1 == 'projects'}">
        <a href="/archive/">Projects</a>
        <!-- ngIf: navLevel2 -->
      </li>
      <li ng-class="{active: navLevel1 == 'search'}">
        <a href="/archive/search">Search</a>
      </li>
      <li ng-class="{active: navLevel1 == 'about'}">
        <a href="/archive/about">About</a>
      </li>
    </ul>
  </div>
</div>
</nav-bar-widget>
<div id="maia-main" role="main">

  <!-- ngIf: issueCtrl.notFound -->

  <div ng-hide="issueCtrl.notFound">
    <!-- Left-side resource nav -->
    <project-resources-widget domain="issueCtrl.domain" project="issueCtrl.projectName" class="ng-isolate-scope"><div class="maia-nav" id="maia-nav-y" role="navigation">
  <!-- ngIf: domain == 'code.google.com' --><ul ng-if="domain == 'code.google.com'" class="ng-scope">
    <li class="active">
      <a href="/archive/p/csipsimple/">Project</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/source">Source</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/issues">Issues</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/wikis">Wikis</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/downloads">Downloads</a>
    </li>
  </ul><!-- end ngIf: domain == 'code.google.com' -->

    <!-- ngIf: domain != 'code.google.com' -->
</div></project-resources-widget>

    <div class="maia-article" role="article">
      <div class="maia-teleport" id="content"></div>
      <div class="maia-cols">
        <div id="gca-project-header" class="maia-col-10">
          <a id="gca-export-to-gh" class="maia-button" href="https://code.google.com/export-to-github/export?project=csipsimple">Export to GitHub</a>
            <img class="gca-project-logo" src="https://storage.googleapis.com/google-code-archive/v2/code.google.com/csipsimple/logo.png">
            <h1 class="ng-binding">csipsimple - issue #1423</h1>
            <p class="ng-binding">support WiFi and 3G simultaneously</p>
        </div>

        <div class="maia-col-10">
          <hr>

        <!-- ngIf: issueCtrl.error -->

        <!-- ngIf: !issueCtrl.error --><div ng-if="!issueCtrl.error" class="ng-scope">
          <!-- Comments -->
          <div class="maia-col-8">
            <!-- ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Dec 9, 2011 by
                  <i class="ng-binding">Happy Rabbit</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>I apologize if this is not the right place to ask the following questions (or part of them).</p>

<p><b>What steps will reproduce the problem?</b>
Hack the ConnectivityService.java to enable simultaneous support of WiFi and 3G in Android Smartphones, using the way specified in the CSipSimple mobility project as well as in the project COIN project.
1. brutally mask the state handling in the MyHandler
2. set the DNS as the Google public DNS - we tried OpenDNS too
3. replace the old services.jar with the newly custom built one - we also tried building the whole Android source code to make a new rom, and flash the new rom into phones.</p>

<p><b>What is the expected output? What do you see instead?</b>
We expect that CSipSimple will work when WiFi and 3G are both available. The web service is working fine with both WiFi and 3G on (we can browse different kinds of websites). However, CSipSimple is not working under any kind of situations: a) WiFi and 3G on, b) only WiFi on, or c) only 3G on. An error message was shown as "Selected network route not allowed with current settings you have setup". </p>

<p><b>What version of the product are you using? On what operating system?</b>
CSipSimple version 0.02-03 r944 on Android 2.3.6</p>

<p><b>Please provide any additional information below.</b>
We also tried the latest version of CSipSimple. But it is not working even for the official Android OS 2.3.6, without our hack of ConnectivityService.java.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #1</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Dec 10, 2011 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Ok. Well I think that the first point would be to understand why it's not working even if you don't change anything to the connectivity service and use a standard phone.
You should probably start to use the latest csipsimple version (0.03).
Then it's probably a problem of sip provider configuration. You may try to collect and send me some logs (see HowToCollectLogs wiki page).</p>

<p>Then about your problem. I'm not pretty sure to understand what you are trying to do. Correct me if I'm wrong by my understand is that you are trying to modify android in order to be able to use several connection (wifi + 3g in your case) instead of only one.</p>

<p>Well, Since android is a linux based system it should be possible to support that in lower level. There is obvious limitation due to route system and that introduce that you'll need at least one default route gateway in order to send packets outside. You may have several gateway depending on the configuration (but normally, it's not what is recommanded for a client but rather for a access point router that have several connections).
So the first point you have to ensure is that 
* android interfaces for 3G and wifi are up
* if you run route -n command on your android you find something coherent with what you want.</p>

<p>Then, you probably already know that android higher software layer actively limit connections to only one at a time. So you have to prevent it from doing that (else it will stop the connection on lower layer).</p>

<p>But, anyway, CSipSimple <em>doesn't</em> care about what android does. It works only at very lower gnu/linux level.</p>

<p>Let me explain what happens when csipsimple try to connect a sip server :
1 - if specific dns are set in csipsimple (there is an option for that) and dns srv option activated. It will connect the dns using dns protocol and ask for domain name resolution if necessary. This is made by opening a socket in native code and basically - as it's done on linux - it will first find the route to send the packet to and send the packets.
2 - it will open a socket to your sip server. And just like previously it will use lower unix socket method. So android higher layer are absolutely <em>not</em> aware about that !</p>

<p>In fact csipsimple rely on a native library that works on linux, windows, macosx, symbian and iphone also. And this library is agnostic about the system and rely on very low socket layers. On linux it's very easy to get several connection up at a time and I already tested the library we use on csipsimple on linux and it just behaves correctly when the linux system is correclty configured.</p>

<p>As consequence, if your android system as a linux system is properly configured to manage several interfaces and route correctly packets to these interfaces, it should be not a problem for csipsimple to manage this kind of configuration.
If your hack is a weird hack that only changes the "java" socket in android sdk, it will not work. BTW, there is a lot of other programs that will not work too, and it's a very weird way to handle this situation because you try to modify OSI layer 3 by modifying application/SDK level. </p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #2</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Dec 10, 2011 by
                  <i class="ng-binding">Happy Rabbit</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Comment deleted</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #3</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Dec 10, 2011 by
                  <i class="ng-binding">Happy Rabbit</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Thank you for the detailed information. The most useful information is that
we need to go through csipsimple and pjsip to find the ways to enable
multiple connections. We have used busybox to set and test the route and
dns in android system: static dns were set, and the route entries were just
the same as the case with single connection for each interface. I thought
csipsimple used the route and dns available from android system (a custom
system including linux kernel) and just never checked the route operations
in pjsip (these routes are all from the same linux kernel anyway? maybe different library). I will update once problem solved.</p>

<p>One thing I want to clarify (in case anybody else has the same issue) is
the following: the hack in Android is necessary because by default Android
2.3.6 allows either wifi or cellular data (2.5G, 3G, 4G, you name it), not
both. Also, when you say "CSipSimple <em>doesn't</em> care about what android does", here by android you mean Android SDK/apps, not including the linux kernel and low-level modules in Android, right? </p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #4</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Dec 10, 2011 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Yes I mean that csipsimple (actually pjsip), does not care on android SDK layer to use network.
Indeed there is parts of linux kernel inside of android that have been modified to do security stuff and to limit what can be done with interface. But it is still a linux based system and native network primitive are still available.</p>

<p>What does pjsip is <em>very</em> basic. It use one of the very lower network layer in the unix system.
You may have a look to this functions : <a href="http://www.manpagez.com/man/2/connect/">http://www.manpagez.com/man/2/connect/</a> and <a href="http://www.manpagez.com/man/2/socket/">http://www.manpagez.com/man/2/socket/</a> .
Also : <a href="http://www.linuxhowtos.org/C_C++/socket.htm">http://www.linuxhowtos.org/C_C++/socket.htm</a> may be useful.</p>

<p>It's the lower C api you'll find about connections. In normal usage, pjsip is not aware of DNS server and of network gateways. This is all managed implicitely by the socket api. There is only one case where I provide DNS server configured in android to pjsip layer and it is when you want to use the DNS SRV (obviously in this case simple name resolution is not enough and pjsip has to make DNS requests by itself). But it's the very only case. For all other connections it has not to be aware of complex things, it just needs to use a standard API which is the socket API.</p>

<p>So basically, if ping or route command works on your android and are able to reach your sip server, there is no reason that could lead pjsip to be lost. </p>

<p>The only things that could break pjsip is the fact that it was not started at correct time and started to establish socket while the network layer were not properly configured yet. 
For this particular purpose (restarting pjsip when connectivity changed), there is something done on pjsip side. There is some basic monitoring of network changes using android API, there is also something that "tries" to monitor VPN changes (at least the most common implementation). 
If the problem is about the monitoring of network reachability, and not the actual connection made by pjsip, this is probably the first thing to look at (this part is in csipsimple - you can try to collect and send me logs about that). 
If the problem appears when pjsip is actually connecting the sip server, the problem is more likely on the fact the lower network api is not properly configured.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments -->
          </div>

          <!-- Sidebar with additional information -->
          <div class="maia-col-4">
            <div class="maia-aside">
              <p>Status: <code class="ng-binding">Invalid</code></p>
              <!-- ngIf: issueCtrl.issue.labels.length > 0 --><p ng-if="issueCtrl.issue.labels.length &gt; 0" class="ng-scope">
                Labels:
                <br>
                <!-- ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Type-Defect</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Priority-Medium</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index -->
              </p><!-- end ngIf: issueCtrl.issue.labels.length > 0 -->
            </div>
          </div>
        </div><!-- end ngIf: !issueCtrl.error -->
      </div>
    </div>

  </div>
</div>
</div></div></div>
    <noscript>
      &lt;p&gt;The Google Code Archive requires JavaScript to be enabled in your browser.&lt;/p&gt;
    </noscript>

    <div id="maia-signature"></div>
    <div class="maia-footer" id="maia-footer">
      <div id="maia-footer-local">
      </div>
      <div id="maia-footer-global">
        <div class="maia-aux">
          <ul>
            <li>
              <a href="//www.google.com/">Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/about/">About Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/privacy/">Privacy</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/terms/">Terms</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="//www.google.com/js/maia.js"></script>
  


</body></html>