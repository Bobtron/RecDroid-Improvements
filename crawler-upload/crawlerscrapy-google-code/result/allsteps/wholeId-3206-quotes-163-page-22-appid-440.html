https://code.google.com/archive/p/csipsimple/issues/1628<!DOCTYPE html><html class="google ng-scope" lang="en" ng-app="codesiteArchive.application"><head>
    <meta charset="utf-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">

    <!-- https://developers.google.com/webmasters/ajax-crawling/docs/specification -->
    <meta name="fragment" content="!">
    <title>Google Code Archive - Long-term storage for Google Code Project Hosting.</title>

    <link rel="icon" type="image/vnd.microsoft.icon" href="/archive/img/project-hosting.ico">
    <script src="//www.google.com/js/google.js"></script>
    <link href="//www.google.com/css/maia.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;lang=en" rel="stylesheet">
    <link rel="stylesheet" href="/archive/archive_css.css">
    <script>
      CLOSURE_NO_DEPS = true;
    </script>
    <script src="/archive/angular.js"></script><style type="text/css">@charset "UTF-8";

[ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak],
.ng-cloak, .x-ng-cloak,
.ng-hide:not(.ng-hide-animate) {
  display: none !important;
}

ng\:form {
  display: block;
}

.ng-animate-shim {
  visibility:hidden;
}

.ng-anchor {
  position:absolute;
}
</style>
    <script src="/archive/pagedown.js"></script>
    <script src="/archive/archive.js"></script>
    <base href="/archive/">
  </head>

  <body>
    <div class="maia-header" id="maia-header" role="banner">
      <div class="maia-aux">
        <a href="/archive/">
          </a><h1><a href="/archive/">
            <img alt="Google" src="//www.google.com/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png"> Code</a>
          </h1>
        
        <a href="/archive/">
          <h2>Archive</h2>
        </a>
        <a class="maia-teleport" href="#content">Skip to content</a>
        <div class="maia-util">
          <form action="/archive/search" class="maia-search ng-pristine ng-valid">
            <input name="q" placeholder="Search this site" type="text">
            <button class="maia-button">
              <span class="maia-search-icon">Search</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ngView: --><div ng-view="" class="ng-scope"><div ng-controller="ProjectIssueCtrl as issueCtrl" class="ng-scope">
<nav-bar-widget nav-level-1="projectCtrl.navLevel1" class="ng-isolate-scope"><div class="maia-nav maia-complex" id="maia-nav-x" role="navigation">
  <div class="maia-aux">
    <ul>
      <li ng-class="{active: navLevel1 == 'projects'}">
        <a href="/archive/">Projects</a>
        <!-- ngIf: navLevel2 -->
      </li>
      <li ng-class="{active: navLevel1 == 'search'}">
        <a href="/archive/search">Search</a>
      </li>
      <li ng-class="{active: navLevel1 == 'about'}">
        <a href="/archive/about">About</a>
      </li>
    </ul>
  </div>
</div>
</nav-bar-widget>
<div id="maia-main" role="main">

  <!-- ngIf: issueCtrl.notFound -->

  <div ng-hide="issueCtrl.notFound">
    <!-- Left-side resource nav -->
    <project-resources-widget domain="issueCtrl.domain" project="issueCtrl.projectName" class="ng-isolate-scope"><div class="maia-nav" id="maia-nav-y" role="navigation">
  <!-- ngIf: domain == 'code.google.com' --><ul ng-if="domain == 'code.google.com'" class="ng-scope">
    <li class="active">
      <a href="/archive/p/csipsimple/">Project</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/source">Source</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/issues">Issues</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/wikis">Wikis</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/downloads">Downloads</a>
    </li>
  </ul><!-- end ngIf: domain == 'code.google.com' -->

    <!-- ngIf: domain != 'code.google.com' -->
</div></project-resources-widget>

    <div class="maia-article" role="article">
      <div class="maia-teleport" id="content"></div>
      <div class="maia-cols">
        <div id="gca-project-header" class="maia-col-10">
          <a id="gca-export-to-gh" class="maia-button" href="https://code.google.com/export-to-github/export?project=csipsimple">Export to GitHub</a>
            <img class="gca-project-logo" src="https://storage.googleapis.com/google-code-archive/v2/code.google.com/csipsimple/logo.png">
            <h1 class="ng-binding">csipsimple - issue #1628</h1>
            <p class="ng-binding">Direct media mode with Google Voice RTP servers</p>
        </div>

        <div class="maia-col-10">
          <hr>

        <!-- ngIf: issueCtrl.error -->

        <!-- ngIf: !issueCtrl.error --><div ng-if="!issueCtrl.error" class="ng-scope">
          <!-- Comments -->
          <div class="maia-col-8">
            <!-- ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 14, 2012 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p><b>What steps will reproduce the problem?</b>
1. Configure SIP server as a gateway to Google Voice service
2. Make call from a remote network (different from LAN, where SIP server is running)
3. Watch the quality of voice. Notice the big latency</p>

<p><b>What is the expected output? What do you see instead?</b>
The latency is not very noticeable.
With media stream going via an intermediate SIP server the latency is very noticeable, making calls almost unbearable.</p>

<p><b>What version of the product are you using? On what operating system?</b>
r1327, Android 2.1</p>

<p><b>Please provide any additional information below.</b></p>

<p>While trying to use CSS with Google Voice, I experience a big problem with voice quality. If I try to use CSS from any places, other then the local LAN (where I run SIP server), the voice has a big additional latency and that makes calls almost unbearable. The big latency comes from RTP stream, which is going from CSS, running on Android phone, to SIP/XMPP server (FreeSWITCH in this case) and only then to Google Voice RTP servers. That additional delay (a hop to / from SIP server) could be avoided if CSS can use Google Voice RTP servers directly, bypassing the extra intermediate server (FreeSWITCH, control channel will still use the intermediate server, but it will not impact the quality of the voice). In other words, if CSS could support direct media mode with Google Voice, that would improve the quality of voice considerably.</p>

<p>I know that CSS currently uses PJSIP library. Is it possible to ask developers of PJSIP library to provide support for CSS to make direct media connections with Google Voice RTP servers?</p>

<p>To support Google Voice RTP servers, SIP client should additionally exchange STUN Binding Request / Result messages. See details:
<a href="http://code.google.com/apis/talk/call_signaling.html#Sequence_of_Events">http://code.google.com/apis/talk/call_signaling.html#Sequence_of_Events</a></p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #1</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 15, 2012 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Ok, two problems here :).</p>

<p>Well first point is that CSipSimple just like all sip client of the world just support direct RTP for the very good reason that a sip client doesn't really know whether it's direct rtp or not. Let me try to explain how media negociation works regarding endpoint address.</p>

<p>When a sip client invite another sip endpoint it will send a SDP (session description protocol). In this SDP the client will announce its own public IP:PORT for media transport. It can optionally use STUN/ICE or TURN mechanism in order to get an accurate public IP:PORT (and STUN, ICE and TURN are all supported options of csipsimple that you can activate in settings &gt; network).
Then the other side (whatever the other side is), will reply with another SDP telling what is his public IP:PORT to send media to. And the SIP client will send media to this IP:PORT. That's just as basic as that.</p>

<p>Then with that in mind, about direct RTP, in fact it's just something that can occurs depending on the topology of your global SIP installation. If your sip server in the middle send the sip client in the SDP its own public IP:PORT, the sip client must send media to this IP:PORT. If your sip server in the middle is in mode "media transparent" or "direct RTP", it will not rewrite the SDP and just transmit the SDP of the other side and so the public IP:PORT of the other side (in your case, the google server). But, that's a feature of the sip server in the middle, and not of the sip client.</p>

<p>So to sum up for this point, your issue is about configuring your sip server. Direct RTP is supported by CSipSimple. I have sip servers that correctly supports that and it works. And actually it's just like all sip clients because it's not a feature of the sip client but of the SIP proxy.</p>

<p>Then about latency, your right, removing your media gateway may help. You can indeed do that by configuring it properly so that it does direct RTP (if possible if that's a gateway to another protocol... that's not always the case when it's a gateway). 
But your problem could also be somewhere else...</p>

<p>The first thing to check is codec in use. If the negociation reach to use PCMU/PCMA (aka G711) which is a 64 kbits codec, it will obviously lead to high latency if you use a public low bandwidth network. 
In this case, you should first try to optimize the codec in use. If your sip gateway is actually a media gateway and does not allow direct RTP, you can take advantage of it and do media transcoding on your sip server/media gateway so that the output codec is something that use lower bandwidth. SILK codec is known to have good perfs bandwidth/quality (it's the codec of Skype). 
The second thing to check is that your sip server/media gateway is properly configured to access the internet. For example, check if you have no firewall misconfigured that reduce bandwidth or protect against flooding for sip media packets or apply different QoS rules. </p>

<p>I hope it will helps you :)
I advise you to join de csipsimple-users google group for more details, I think that this kind of issue could be helpful for other users and maybe other users already do the same kind of installation than you and already succeeded in doing a media gateway to google voice servers.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #2</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 15, 2012 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Thank you, Regis. Everything you said is correct. But I think it's NOT the problem with configuration. The problem is with specific implementation of Google Voice (GV) RTP servers (see "XEP-0167: Jingle RTP Sessions" <a href="http://xmpp.org/extensions/xep-0167.html">http://xmpp.org/extensions/xep-0167.html</a>).</p>

<p>They (GV RTP srvers) require other parties (e.g. SIP clients like CSS or SIP/XMPP gateways) to exchange with STUN Binding Request / Result messages via RTP. Initiator must send "STUN Binding Request" and get "STUN Binding Result" back. After that, the responder has to repeat that exchange too (using an opposite direction, of course). And then they have to continue that exchange (between GV RTP servers and CSS) on a regular basis. Without that audio channel is not working, even if CSS gets the correct IP:PORT of the GV RTP server. Again, it's not about getting correct IP:PORT info of GV server, it's about exchange with STUN binding messages via RTP channel (and Google calls it "STUN connectivity checks"), all the time...</p>

<p>Here is a cite from this document: <a href="http://code.google.com/apis/talk/call_signaling.html">http://code.google.com/apis/talk/call_signaling.html</a>
"The establishment of and maintenance of RTP and RTCP channels is done by performing connectivity checks against all received candidates using STUN binding requests and responses. For a given candidate to be considered usable, it must respond to a STUN binding request with an appropriate STUN binding response. In addition to the initial connectivity checks, STUN is used after the channel is established to ensure it is still alive."</p>

<p>Regis, if you think it's just a configuration issue, please let me know how to configure CSS to get direct media from GV RTP servers. What solution do you use (SIP/XMPP server) and how? Thank you in advance.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #3</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 16, 2012 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Ok, got it. Sorry I misunderstood the point.</p>

<p>Indeed, I recall that now, that's something that I discussed before with Aaron from SipSorcery. 
Since I don't find the issue here, we probably talked about that in private mail, but the conclusion was that the point is more relevant of the sip stack.
You can have a look to the thread raised by Aaron after we talked together here : <a href="http://lists.pjsip.org/pipermail/pjsip_lists.pjsip.org/2010-December/012339.html">http://lists.pjsip.org/pipermail/pjsip_lists.pjsip.org/2010-December/012339.html</a> </p>

<p>Maybe if you have things to add to this discussion (if there is evolutions on Gtalk servers), you can enrich the thread. </p>

<p>My understood of the problem was that there were something missing on google side to completely support it the standard way (with the already existing ICE feature of pjsip).</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #4</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 16, 2012 by
                  <i class="ng-binding">Quick Giraffe</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Thank you for the link. That old (2010) conversation is exactly about the same problem, indeed. I followed the thread and at the end of it I found a link to PJSIP ticket, opened and eventually fixed / closed: <a href="https://trac.pjsip.org/repos/ticket/1173">https://trac.pjsip.org/repos/ticket/1173</a></p>

<p>Post referring to the ticket is: <a href="http://lists.pjsip.org/pipermail/pjsip_lists.pjsip.org/2010-December/012341.html">http://lists.pjsip.org/pipermail/pjsip_lists.pjsip.org/2010-December/012341.html</a></p>

<p>The good news is - PJSIP developers offer some kind of a solution:
"This ticket adds a new pjsua callback to allow application use custom media transport for a particular call."
That means, that application using PJSIP can use callback to add a media transport adapter (similar to SRTP), which will provide required support for GV. I think, that's a big step in the right direction.</p>

<p>If I understand that correctly, application (CSS in this case) can offer that specific support for direct media mode with Google Voice RTP servers. Small problem remains, how CSS can recognize, that the particular media channel requires Google Voice adapter? I think it could be done by checking, for example, attribute lines in SDP. If there is attribute "a=Google Voice", CSS should use adapter for GV. If there is no such attribute, the media goes without new GV adapter.</p>

<p>How that new attribute will appear in SDP? The SIP/XMPP gateway should add it. For example, FreeSWITCH can add it to calls, made via GV, right now.</p>

<p>What do you think, Regis? Is it possible to check that attribute on application level? Or it should be done on PJSIP level? In former case we can do it without any help from PJSIP developers (assuming they have implemented ticket 1173 correctly). Otherwise we need some help from them and it may delay the development.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #5</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 18, 2012 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Yes, indeed the media adapter should allow to hook in the media transport. 
Actually that's already what Werner did for ZRTP transport for CSipSimple. 
So there is indeed some already working thing doing the same kind of change of RTP transport.</p>

<p>However, I didn't yet had a closer look on how to choose the media adapter. It's seems to be a simple callback. So if we want to support gv and zrtp and normal at the same time, maybe some wrapper will be needed. I can help on this point since it was planned anyway in order to allow per account ZRTP support.</p>

<p>So I think that a first step would be to have a media adapter like the one we have for ZRTP that works with GV RTP servers. The problem is that I've no dev env to test GV and not enough time to do that by myself in short future. </p>

<p>However, if you succeed doing some media adapter like Werner did for ZRTP I'll do the last step to integrate it in android and in csipsimple wrapper around pjsip. If you want to try something, I would gave to you the same advise that I gave to Werner to start doing that on PC (linux or windows) as a simple extension of pjsip. It's easier to test than on android because the building overhead is lighter.
You can have a look to the ZRTP4pj project =&gt; 
<a href="https://github.com/wernerd/ZRTP4PJ">https://github.com/wernerd/ZRTP4PJ</a></p>

<p>The example project will be very useful to get started with pjsua and have the media adapter of your choice behind :
<a href="https://github.com/wernerd/ZRTP4PJ/tree/master/example">https://github.com/wernerd/ZRTP4PJ/tree/master/example</a></p>

<p>If you contribute such a project, I'll be able to integrate this to csipsimple, but it will also potentially benefit many other sip app based on pjsip (like siphon on iphone, blink on linux, mac and windows, telephone on mac etc etc etc). So I'll not be the only one to thanks you for this kind of contrib ;).</p>

<p>Since, it will maybe require you to use ICE/NAT layers of pjsip as helpers and I never played with this, you can ask the pjsip mailing list for help on these points. If it's about pure pjsua integration, you can directly ask me in PM or on csipsimple-dev google group.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments -->
          </div>

          <!-- Sidebar with additional information -->
          <div class="maia-col-4">
            <div class="maia-aside">
              <p>Status: <code class="ng-binding">WontFix</code></p>
              <!-- ngIf: issueCtrl.issue.labels.length > 0 --><p ng-if="issueCtrl.issue.labels.length &gt; 0" class="ng-scope">
                Labels:
                <br>
                <!-- ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Type-Defect</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Priority-Medium</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index -->
              </p><!-- end ngIf: issueCtrl.issue.labels.length > 0 -->
            </div>
          </div>
        </div><!-- end ngIf: !issueCtrl.error -->
      </div>
    </div>

  </div>
</div>
</div></div></div>
    <noscript>
      &lt;p&gt;The Google Code Archive requires JavaScript to be enabled in your browser.&lt;/p&gt;
    </noscript>

    <div id="maia-signature"></div>
    <div class="maia-footer" id="maia-footer">
      <div id="maia-footer-local">
      </div>
      <div id="maia-footer-global">
        <div class="maia-aux">
          <ul>
            <li>
              <a href="//www.google.com/">Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/about/">About Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/privacy/">Privacy</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/terms/">Terms</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="//www.google.com/js/maia.js"></script>
  


</body></html>