https://code.google.com/archive/p/csipsimple/issues/2655<!DOCTYPE html><html class="google ng-scope" lang="en" ng-app="codesiteArchive.application"><head>
    <meta charset="utf-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">

    <!-- https://developers.google.com/webmasters/ajax-crawling/docs/specification -->
    <meta name="fragment" content="!">
    <title>Google Code Archive - Long-term storage for Google Code Project Hosting.</title>

    <link rel="icon" type="image/vnd.microsoft.icon" href="/archive/img/project-hosting.ico">
    <script src="//www.google.com/js/google.js"></script>
    <link href="//www.google.com/css/maia.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;lang=en" rel="stylesheet">
    <link rel="stylesheet" href="/archive/archive_css.css">
    <script>
      CLOSURE_NO_DEPS = true;
    </script>
    <script src="/archive/angular.js"></script><style type="text/css">@charset "UTF-8";

[ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak],
.ng-cloak, .x-ng-cloak,
.ng-hide:not(.ng-hide-animate) {
  display: none !important;
}

ng\:form {
  display: block;
}

.ng-animate-shim {
  visibility:hidden;
}

.ng-anchor {
  position:absolute;
}
</style>
    <script src="/archive/pagedown.js"></script>
    <script src="/archive/archive.js"></script>
    <base href="/archive/">
  </head>

  <body>
    <div class="maia-header" id="maia-header" role="banner">
      <div class="maia-aux">
        <a href="/archive/">
          </a><h1><a href="/archive/">
            <img alt="Google" src="//www.google.com/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png"> Code</a>
          </h1>
        
        <a href="/archive/">
          <h2>Archive</h2>
        </a>
        <a class="maia-teleport" href="#content">Skip to content</a>
        <div class="maia-util">
          <form action="/archive/search" class="maia-search ng-pristine ng-valid">
            <input name="q" placeholder="Search this site" type="text">
            <button class="maia-button">
              <span class="maia-search-icon">Search</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ngView: --><div ng-view="" class="ng-scope"><div ng-controller="ProjectIssueCtrl as issueCtrl" class="ng-scope">
<nav-bar-widget nav-level-1="projectCtrl.navLevel1" class="ng-isolate-scope"><div class="maia-nav maia-complex" id="maia-nav-x" role="navigation">
  <div class="maia-aux">
    <ul>
      <li ng-class="{active: navLevel1 == 'projects'}">
        <a href="/archive/">Projects</a>
        <!-- ngIf: navLevel2 -->
      </li>
      <li ng-class="{active: navLevel1 == 'search'}">
        <a href="/archive/search">Search</a>
      </li>
      <li ng-class="{active: navLevel1 == 'about'}">
        <a href="/archive/about">About</a>
      </li>
    </ul>
  </div>
</div>
</nav-bar-widget>
<div id="maia-main" role="main">

  <!-- ngIf: issueCtrl.notFound -->

  <div ng-hide="issueCtrl.notFound">
    <!-- Left-side resource nav -->
    <project-resources-widget domain="issueCtrl.domain" project="issueCtrl.projectName" class="ng-isolate-scope"><div class="maia-nav" id="maia-nav-y" role="navigation">
  <!-- ngIf: domain == 'code.google.com' --><ul ng-if="domain == 'code.google.com'" class="ng-scope">
    <li class="active">
      <a href="/archive/p/csipsimple/">Project</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/source">Source</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/issues">Issues</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/wikis">Wikis</a>
    </li>
    <li>
      <a href="/archive/p/csipsimple/downloads">Downloads</a>
    </li>
  </ul><!-- end ngIf: domain == 'code.google.com' -->

    <!-- ngIf: domain != 'code.google.com' -->
</div></project-resources-widget>

    <div class="maia-article" role="article">
      <div class="maia-teleport" id="content"></div>
      <div class="maia-cols">
        <div id="gca-project-header" class="maia-col-10">
          <a id="gca-export-to-gh" class="maia-button" href="https://code.google.com/export-to-github/export?project=csipsimple">Export to GitHub</a>
            <img class="gca-project-logo" src="https://storage.googleapis.com/google-code-archive/v2/code.google.com/csipsimple/logo.png">
            <h1 class="ng-binding">csipsimple - issue #2655</h1>
            <p class="ng-binding">Uses wrong IP address in Via/Contact headers when on OpenVPN</p>
        </div>

        <div class="maia-col-10">
          <hr>

        <!-- ngIf: issueCtrl.error -->

        <!-- ngIf: !issueCtrl.error --><div ng-if="!issueCtrl.error" class="ng-scope">
          <!-- Comments -->
          <div class="maia-col-8">
            <!-- ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Feb 28, 2014 by
                  <i class="ng-binding">Helpful Wombat</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p><b>What steps will reproduce the problem?</b>
1. Install "OpenVPN for Android" from Play Store
2. Connect to an OpenVPN server
3. Attempt to REGISTER with a SIP server over the VPN</p>

<p><b>What is the expected output? What do you see instead?</b></p>

<p>SIP messages sent over the VPN should have the phone's VPN IP in the Via and Contact headers. Instead they have the phone's underlying wifi IP in the Via and Contact headers. So no SIP responses reach the phone.</p>

<p><b>What version of the product are you using? On what device / operating</b>
<b>system?</b></p>

<p>Nexus 5
Android 4.4.2
csipsimple 1.02.00 r2330</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #1</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Mar 1, 2014 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>I'm not sure to get the details of the problem but it can be a normal behavior. I did a lot of tests with VPN on the device, and everything I observed was expected. It's often not obvious to understand but it's always strict regarding RFC.
So can you collect and send logs. See HowToCollectLogs wiki page (ref this issue number in the email produced).</p>

<p>The fact that some interface is used to reach a server does not means it also should be used for media for example.
The "allow contact rewrite" option that is enabled by default should do the trick so that the registration will be finally made with the correct ip address (after the first step).
For the media, if the default interface is not the vpn interface in your topology, the good way to configure the app is to enable ICE.</p>

<p>Because else, there is absolutely no good reason to use the vpn interface. To support all possible topologies things needs to be clear and not magic should happen else we will loose support of some topology (it's totally possible to have invite going through your sip server in the vpn network but media established over public network). </p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #2</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Jan 30, 2015 by
                  <i class="ng-binding">Helpful Dog</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Yes, this bug is present. I have Asterisk server in freeBSD Jail and OpenVPN tunnel. I can "see" clients from jail box and via versa. Problem in csipsimple.</p>

<p>Look at this log</p>

<p>IP 192.168.254.130.40671 &gt; 192.168.254.10.5060: UDP, length 834
E..^..@.@..........
.....J. INVITE sip:5433@192.168.254.10 SIP/2.0
v: SIP/2.0/UDP 192.168.1.134:40671;rport;branch=z9hG4bKPjMEB0vxQe7jfxIZjwS902SI28SLUvnVW3
Max-Forwards: 70
f: ;tag=WFf6MI2aLQJa5aJL295WTw23ywZa.2Vo
t: 
m: 
i: TOvZBIOxUAokCoOBHFouCSgh5Bdd7nbS
CSeq: 21835 INVITE
Route: 
k: replaces, 100rel, timer, norefersub
x: 1800
Min-SE: 90
User-Agent: CSipSimple_bird77_a_cu_ics2-15/r2457
c: application/sdp
l:   302</p>

<p>Here 192.168.254.10 - Asterisk's IP-address
192.168.254.130 - client's tunnel endpoint
192.168.1.134 - WI-FI address</p>

<p>I think it must be fixed.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #3</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Jan 30, 2015 by
                  <i class="ng-binding">Helpful Dog</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>As workaround you should use "nat = comedia" in sip.conf</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #4</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Feb 2, 2015 by
                  <i class="ng-binding">Quick Hippo</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>@ffaxinn : I don't think it's a bug in csipsimple.
It's pretty long to explain and I did it a couple of times (read for example : <a href="https://code.google.com/p/csipsimple/issues/detail?id=2375#c2">https://code.google.com/p/csipsimple/issues/detail?id=2375#c2</a>)</p>

<p>To try to be very short to explain why it behaves this way :
In SIP, media and control plan are distinct. There is absolutely nothing that force your media to go the same way your sip control.
And it makes sense it some cases !!!
SIP allows for example your call to be created using your sip server in your VPN but media to go directly in the shortest possible way over the internet using for example totally encrypted peer to peer method.</p>

<p>Now your case. Apparently, you would like your media to go the same network your sip does. Unfortunately your log does not show the part about media, so I can just guess that's your case, which is the same than many other people ;). And I guess from your solution than problem was about media.</p>

<p>Fine, that's possible, but that will require you to learn a little more about SIP vs networking :)
There is one very simple way to do thanks to recent addition in pjsip (the underlying sip stack behind csipsimple). In expert account mode (<a href="https://code.google.com/p/csipsimple/wiki/ExpertSettingMode?wl=en#Account_settings">https://code.google.com/p/csipsimple/wiki/ExpertSettingMode?wl=en#Account_settings</a>), you can check the Allow SDP NAT rewrite option (in nat traversal section).
This way, the app will not assume it should announce media on the default route interface of your device, but instead try to use the one that was used to reach your sip server.</p>

<p>A second solution, which I advise to consider for all providing a SIP server and with a complex network topology (several network/VPN etc etc), is to setup a STUN server on your sip server and enable STUN+ICE in the app.
This way, the app will ask stun server what should be it's media public IP to stun server(s) (thx to STUN); and announce to remote all possible media public IP (thanks to ICE, which allows to announce all interface + all ip resolved by all stun servers).</p>

<p>That's why it's not a bug, but something in the configuration that does not match the topology you'd like to achieve. SIP can become complicate to configure depending on topology. The next gen com stuff uses by default methods such as STUN+ICE (it's the case of webRTC), or uses very restricted scenarios available.
The point about nat media is not the only one that can be configured and that you might have to configure to get something working when you are providing a SIP server. There is no magic config that works for anyone because there is many possible configuration for network+SIP. However, the expert setting mode of csipsimple should allow to tune every single thing on how SIP stack behaves. That's basically why there is this "wizard" approach with predefined settings depending on sip provider. And you can check in the code, many sip provider has their own different settings to get sip working properly even if they almost always have only to manage public connection.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments -->
          </div>

          <!-- Sidebar with additional information -->
          <div class="maia-col-4">
            <div class="maia-aside">
              <p>Status: <code class="ng-binding">Need-Details</code></p>
              <!-- ngIf: issueCtrl.issue.labels.length > 0 --><p ng-if="issueCtrl.issue.labels.length &gt; 0" class="ng-scope">
                Labels:
                <br>
                <!-- ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Type-Defect</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Priority-Medium</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index -->
              </p><!-- end ngIf: issueCtrl.issue.labels.length > 0 -->
            </div>
          </div>
        </div><!-- end ngIf: !issueCtrl.error -->
      </div>
    </div>

  </div>
</div>
</div></div></div>
    <noscript>
      &lt;p&gt;The Google Code Archive requires JavaScript to be enabled in your browser.&lt;/p&gt;
    </noscript>

    <div id="maia-signature"></div>
    <div class="maia-footer" id="maia-footer">
      <div id="maia-footer-local">
      </div>
      <div id="maia-footer-global">
        <div class="maia-aux">
          <ul>
            <li>
              <a href="//www.google.com/">Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/about/">About Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/privacy/">Privacy</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/terms/">Terms</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="//www.google.com/js/maia.js"></script>
  


</body></html>