https://code.google.com/archive/p/android-daisy-epub-reader/issues/61<!DOCTYPE html><html class="google ng-scope" lang="en" ng-app="codesiteArchive.application"><head>
    <meta charset="utf-8">
    <meta content="initial-scale=1, minimum-scale=1, width=device-width" name="viewport">

    <!-- https://developers.google.com/webmasters/ajax-crawling/docs/specification -->
    <meta name="fragment" content="!">
    <title>Google Code Archive - Long-term storage for Google Code Project Hosting.</title>

    <link rel="icon" type="image/vnd.microsoft.icon" href="/archive/img/project-hosting.ico">
    <script src="//www.google.com/js/google.js"></script>
    <link href="//www.google.com/css/maia.css" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Open+Sans:300,400,600,700&amp;lang=en" rel="stylesheet">
    <link rel="stylesheet" href="/archive/archive_css.css">
    <script>
      CLOSURE_NO_DEPS = true;
    </script>
    <script src="/archive/angular.js"></script><style type="text/css">@charset "UTF-8";

[ng\:cloak], [ng-cloak], [data-ng-cloak], [x-ng-cloak],
.ng-cloak, .x-ng-cloak,
.ng-hide:not(.ng-hide-animate) {
  display: none !important;
}

ng\:form {
  display: block;
}

.ng-animate-shim {
  visibility:hidden;
}

.ng-anchor {
  position:absolute;
}
</style>
    <script src="/archive/pagedown.js"></script>
    <script src="/archive/archive.js"></script>
    <base href="/archive/">
  </head>

  <body>
    <div class="maia-header" id="maia-header" role="banner">
      <div class="maia-aux">
        <a href="/archive/">
          </a><h1><a href="/archive/">
            <img alt="Google" src="//www.google.com/images/branding/googlelogo/1x/googlelogo_color_116x41dp.png"> Code</a>
          </h1>
        
        <a href="/archive/">
          <h2>Archive</h2>
        </a>
        <a class="maia-teleport" href="#content">Skip to content</a>
        <div class="maia-util">
          <form action="/archive/search" class="maia-search ng-pristine ng-valid">
            <input name="q" placeholder="Search this site" type="text">
            <button class="maia-button">
              <span class="maia-search-icon">Search</span>
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- ngView: --><div ng-view="" class="ng-scope"><div ng-controller="ProjectIssueCtrl as issueCtrl" class="ng-scope">
<nav-bar-widget nav-level-1="projectCtrl.navLevel1" class="ng-isolate-scope"><div class="maia-nav maia-complex" id="maia-nav-x" role="navigation">
  <div class="maia-aux">
    <ul>
      <li ng-class="{active: navLevel1 == 'projects'}">
        <a href="/archive/">Projects</a>
        <!-- ngIf: navLevel2 -->
      </li>
      <li ng-class="{active: navLevel1 == 'search'}">
        <a href="/archive/search">Search</a>
      </li>
      <li ng-class="{active: navLevel1 == 'about'}">
        <a href="/archive/about">About</a>
      </li>
    </ul>
  </div>
</div>
</nav-bar-widget>
<div id="maia-main" role="main">

  <!-- ngIf: issueCtrl.notFound -->

  <div ng-hide="issueCtrl.notFound">
    <!-- Left-side resource nav -->
    <project-resources-widget domain="issueCtrl.domain" project="issueCtrl.projectName" class="ng-isolate-scope"><div class="maia-nav" id="maia-nav-y" role="navigation">
  <!-- ngIf: domain == 'code.google.com' --><ul ng-if="domain == 'code.google.com'" class="ng-scope">
    <li class="active">
      <a href="/archive/p/android-daisy-epub-reader/">Project</a>
    </li>
    <li>
      <a href="/archive/p/android-daisy-epub-reader/source">Source</a>
    </li>
    <li>
      <a href="/archive/p/android-daisy-epub-reader/issues">Issues</a>
    </li>
    <li>
      <a href="/archive/p/android-daisy-epub-reader/wikis">Wikis</a>
    </li>
    <li>
      <a href="/archive/p/android-daisy-epub-reader/downloads">Downloads</a>
    </li>
  </ul><!-- end ngIf: domain == 'code.google.com' -->

    <!-- ngIf: domain != 'code.google.com' -->
</div></project-resources-widget>

    <div class="maia-article" role="article">
      <div class="maia-teleport" id="content"></div>
      <div class="maia-cols">
        <div id="gca-project-header" class="maia-col-10">
          <a id="gca-export-to-gh" class="maia-button" href="https://code.google.com/export-to-github/export?project=android-daisy-epub-reader">Export to GitHub</a>
            <img class="gca-project-logo" src="https://storage.googleapis.com/google-code-archive/v2/code.google.com/android-daisy-epub-reader/logo.png">
            <h1 class="ng-binding">android-daisy-epub-reader - issue #61</h1>
            <p class="ng-binding">DaisyReader crashes during search for books with XML Parser error when a book has an unknown encoding</p>
        </div>

        <div class="maia-col-10">
          <hr>

        <!-- ngIf: issueCtrl.error -->

        <!-- ngIf: !issueCtrl.error --><div ng-if="!issueCtrl.error" class="ng-scope">
          <!-- Comments -->
          <div class="maia-col-8">
            <!-- ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on May 18, 2012 by
                  <i class="ng-binding">Helpful Panda</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p><b>What steps will reproduce the problem?</b>
1. Have a book on the SD Card with an 'unknown' encoding - one the app / the SAX doesn't know how to parse. 
2. Use the 'Search for Books' button to find books on the SD Card.</p>

<p>What is the expected output? 
- The app should present the user with a list of the recognised DAISY 2.02 format books. The app should not crash :)</p>

<p>What do you see instead?
The app crashes and quits.</p>

<p>Note: There are 2 issues to address:
   1. Discovering why a particular book isn't parsed correctly
   2. Catching the runtime exception programatically and presenting a friendly, useful, and actionable message to the user instead of crashing.</p>

<p>Logcat contains the following output</p>

<p>I/DaisyBookFinder(31007): onCreate
I/DaisyBookFinder(31007): The root folder to search is: /sdcard/daisy/
I/BookValidator(31007): Book available at : /sdcard/daisy/unpacked/class6hindi
I/BookValidator(31007): Book available at : /sdcard/daisy/unpacked/japan/Bangumi 202 audio NCC NHK11
I/BookValidator(31007): Book available at : /sdcard/daisy/unpacked/japan/gon-ruby-mp3 2.02 full text full audio
I/BookValidator(31007): Book available at : /sdcard/daisy/unpacked/Andrija Nikolic - Ziva hrana kao lijek
I/BookValidator(31007): Book available at : /sdcard/daisy/unpacked/norvay/2.02 full text full audio
I/BookValidator(31007): Book available at : /sdcard/daisy/unpacked/norvay/2.02 ncc audio
I/DaisyBookFinder(31007): External Storage is: /mnt/sdcard
I/DaisyBookImplementation(31007): /
I/DaisyParser(31007): XMLFILE /sdcard/daisy/unpacked/class6hindi/ncc.html
D/dalvikvm(31007): GC_CONCURRENT freed 228K, 3% free 12851K/13127K, paused 2ms+2ms
I/DaisyBookImplementation(31007): /
I/DaisyParser(31007): XMLFILE /sdcard/daisy/unpacked/japan/Bangumi 202 audio NCC NHK11/ncc.html
D/AndroidRuntime(31007): Shutting down VM
W/dalvikvm(31007): threadid=1: thread exiting with uncaught exception (group=0x40a311f8)
E/AndroidRuntime(31007): FATAL EXCEPTION: main
E/AndroidRuntime(31007): java.lang.RuntimeException: Unable to start activity ComponentInfo{com.ader/com.ader.ui.DaisyBookFinder}: j
ava.lang.RuntimeException: org.apache.harmony.xml.ExpatParser$ParseException: At line 1, column 0: unknown encoding
E/AndroidRuntime(31007):        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:1956)
E/AndroidRuntime(31007):        at android.app.ActivityThread.handleLaunchActivity(ActivityThread.java:1981)
E/AndroidRuntime(31007):        at android.app.ActivityThread.access$600(ActivityThread.java:123)
E/AndroidRuntime(31007):        at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1147)
E/AndroidRuntime(31007):        at android.os.Handler.dispatchMessage(Handler.java:99)
E/AndroidRuntime(31007):        at android.os.Looper.loop(Looper.java:137)
E/AndroidRuntime(31007):        at android.app.ActivityThread.main(ActivityThread.java:4424)
E/AndroidRuntime(31007):        at java.lang.reflect.Method.invokeNative(Native Method)
E/AndroidRuntime(31007):        at java.lang.reflect.Method.invoke(Method.java:511)
E/AndroidRuntime(31007):        at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:784)
E/AndroidRuntime(31007):        at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:551)
E/AndroidRuntime(31007):        at dalvik.system.NativeStart.main(Native Method)
E/AndroidRuntime(31007): Caused by: java.lang.RuntimeException: org.apache.harmony.xml.ExpatParser$ParseException: At line 1, column
 0: unknown encoding
E/AndroidRuntime(31007):        at com.ader.DaisyParser.parseNccContents(DaisyParser.java:146)
E/AndroidRuntime(31007):        at com.ader.DaisyParser.openAndParseFromFile(DaisyParser.java:67)
E/AndroidRuntime(31007):        at com.ader.OldDaisyBookImplementation.openFromFile(OldDaisyBookImplementation.java:123)
E/AndroidRuntime(31007):        at com.ader.ui.DaisyBookFinder.populateList(DaisyBookFinder.java:92)
E/AndroidRuntime(31007):        at com.ader.ui.DaisyBookFinder.onCreate(DaisyBookFinder.java:48)
E/AndroidRuntime(31007):        at android.app.Activity.performCreate(Activity.java:4465)
E/AndroidRuntime(31007):        at android.app.Instrumentation.callActivityOnCreate(Instrumentation.java:1049)
E/AndroidRuntime(31007):        at android.app.ActivityThread.performLaunchActivity(ActivityThread.java:1920)
E/AndroidRuntime(31007):        ... 11 more
E/AndroidRuntime(31007): Caused by: org.apache.harmony.xml.ExpatParser$ParseException: At line 1, column 0: unknown encoding
E/AndroidRuntime(31007):        at org.apache.harmony.xml.ExpatParser.parseFragment(ExpatParser.java:515)
E/AndroidRuntime(31007):        at org.apache.harmony.xml.ExpatParser.parseDocument(ExpatParser.java:474)
E/AndroidRuntime(31007):        at org.apache.harmony.xml.ExpatReader.parse(ExpatReader.java:321)
E/AndroidRuntime(31007):        at org.apache.harmony.xml.ExpatReader.parse(ExpatReader.java:279)
E/AndroidRuntime(31007):        at com.ader.DaisyParser.parseNccContents(DaisyParser.java:142)
E/AndroidRuntime(31007):        ... 18 more
W/ActivityManager(  191):   Force finishing activity com.ader/.ui.DaisyBookFinder
W/ActivityManager(  191):   Force finishing activity com.ader/.ui.HomeScreen
D/dalvikvm(31007): GC_CONCURRENT freed 136K, 2% free 13250K/13447K, paused 2ms+17ms
W/ActivityManager(  191): Activity pause timeout for ActivityRecord{41efdc30 com.ader/.ui.DaisyBookFinder}
D/dalvikvm(  486): GC_CONCURRENT freed 3738K, 26% free 20592K/27463K, paused 4ms+3ms
D/dalvikvm(  486): GC_FOR_ALLOC freed 396K, 25% free 20735K/27463K, paused 48ms
I/ActivityManager(  191): No longer want com.android.voicedialer (pid 30472): hidden #16
D/dalvikvm(  486): GC_CONCURRENT freed 8K, 18% free 22664K/27463K, paused 11ms+6ms
I/Process (31007): Sending signal. PID: 31007 SIG: 9
I/ActivityManager(  191): Process com.ader (pid 31007) has died.
I/WindowManager(  191): WIN DEATH: Window{419e3b50 com.ader/com.ader.ui.HomeScreen paused=true}
W/ActivityManager(  191): Activity destroy timeout for ActivityRecord{41ee68a8 com.ader/.ui.HomeScreen}
W/ActivityManager(  191): Activity destroy timeout for ActivityRecord{41efdc30 com.ader/.ui.DaisyBookFinder}</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #1</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Oct 21, 2012 by
                  <i class="ng-binding">Helpful Panda</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>I have applied a minimal fix to the existing DaisyReader so at least the app doesn't crash when the underlying SAX parser complains by raising an exception when it is unable to process the ncc file for a book. The problem happens when the SAX parser encounters Shift_JIS encoding in ncc.html (and probably also happens for other files). I'll now investigate how to convince SAX to parse Shift_JIS files on Android.</p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments --><div ng-repeat="comment in issueCtrl.issue.comments" class="ng-scope">
              <div>
                <!-- ngIf: comment.id --><h3 ng-if="comment.id" class="ng-binding ng-scope">Comment #2</h3><!-- end ngIf: comment.id -->
                <!-- ms to seconds. -->
                <small class="ng-binding">
                  Posted on Jan 17, 2013 by
                  <i class="ng-binding">Helpful Panda</i>
                </small>
              </div>

              <!-- TODO(chrsmith): Get the formatting right. Google Code comments
              are not stored in wiki/markdown or HTML format. So we probably need to
              create a custom filter to get 100% paritiy. -->
              <!-- ngIf: comment.content --><span ng-if="comment.content" class="ng-scope">
                <markdown-widget text="comment.content" class="markdown"><p>Here are a bunch of links that might help me to resolve the problem when I have the energy to work on a problem that's rare for users of this app AFAIK</p>

<p><a href="http://stackoverflow.com/questions/11544713/utf-8-and-sjis-problems-on-android-and-sockets">http://stackoverflow.com/questions/11544713/utf-8-and-sjis-problems-on-android-and-sockets</a> 
The following looks interesting 
<a href="http://www.coderanch.com/t/450324/java/java/parsing-Japanese-SHIFT-JIS-Characters">http://www.coderanch.com/t/450324/java/java/parsing-Japanese-SHIFT-JIS-Characters</a></p>

<p><a href="http://docs.oracle.com/javase/1.4.2/docs/api/java/nio/charset/CharsetDecoder.html#decode(java.nio.ByteBuffer">http://docs.oracle.com/javase/1.4.2/docs/api/java/nio/charset/CharsetDecoder.html#decode(java.nio.ByteBuffer</a>, java.nio.CharBuffer, boolean)</p>

<p>If in doubt perhaps we can replace the parser for a generic Java implementation?
<a href="http://xerces.apache.org/xerces2-j/faq-general.html">http://xerces.apache.org/xerces2-j/faq-general.html</a></p></markdown-widget>
              </span><!-- end ngIf: comment.content -->
              <!-- ngIf: !comment.content -->

              <!-- ngIf: comment.attachments.length -->
              <!-- ngRepeat: attachment in comment.attachments -->
            </div><!-- end ngRepeat: comment in issueCtrl.issue.comments -->
          </div>

          <!-- Sidebar with additional information -->
          <div class="maia-col-4">
            <div class="maia-aside">
              <p>Status: <code class="ng-binding">Accepted</code></p>
              <!-- ngIf: issueCtrl.issue.labels.length > 0 --><p ng-if="issueCtrl.issue.labels.length &gt; 0" class="ng-scope">
                Labels:
                <br>
                <!-- ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Type-Defect</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index --><span ng-repeat="label in issueCtrl.issue.labels track by $index" class="ng-scope">
                  <span class="gca-label ng-binding">Priority-High</span>
                </span><!-- end ngRepeat: label in issueCtrl.issue.labels track by $index -->
              </p><!-- end ngIf: issueCtrl.issue.labels.length > 0 -->
            </div>
          </div>
        </div><!-- end ngIf: !issueCtrl.error -->
      </div>
    </div>

  </div>
</div>
</div></div></div>
    <noscript>
      &lt;p&gt;The Google Code Archive requires JavaScript to be enabled in your browser.&lt;/p&gt;
    </noscript>

    <div id="maia-signature"></div>
    <div class="maia-footer" id="maia-footer">
      <div id="maia-footer-local">
      </div>
      <div id="maia-footer-global">
        <div class="maia-aux">
          <ul>
            <li>
              <a href="//www.google.com/">Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/about/">About Google</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/privacy/">Privacy</a>
            </li>
            <li>
              <a href="//www.google.com/intl/en/policies/terms/">Terms</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <script src="//www.google.com/js/maia.js"></script>
  


</body></html>